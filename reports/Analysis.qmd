---
title: "The Impact of Income and Substance Use on Health Outcomes in US Counties"
subtitle: "Using Data from CHR 2023"
date: last-modified
format:
  html:
    css: styles.css
    toc: true
    number-sections: true
    date-format: iso
    embed-resources: true
    code-overflow: wrap
    theme: default
---


```{r}

knitr::opts_chunk$set(warning = FALSE)

```


```{r}
#| message: false

library(Hmisc)
library(janitor)
library(naniar)
library(sessioninfo)
library(car)
library(mosaic)
suppressPackageStartupMessages(library(here))
library(gt)
library(glue)
library(patchwork)
library(broom)
library(rstatix)
library(tidyverse)



theme_set(theme_bw())
knitr::opts_chunk$set(comment = NA)
```

# Data Ingest

```{r Data Task 1 Ingest the raw data}


data_url <- "https://www.countyhealthrankings.org/sites/default/files/media/document/analytic_data2023_0.csv"

chr_2023_raw <- read_csv(data_url, skip = 1, guess_max = 4000,show_col_types = FALSE)


chr_2023_raw <- chr_2023_raw %>% filter(county_ranked == 1)

dim(chr_2023_raw)


```

# State Selection

The goal of the analysis will include all of the counties in the Unitied States of America. 

```{r State Selection}


chr_2023 <- chr_2023_raw %>% mutate(state = factor(state))

chr_2023 %>% count(state)

nrow(chr_2023)


```

There are 3082 total counties in this data set.


# Variable Selection

```{r variable selection}

chr_2023 <- chr_2023 %>% select(fipscode, 
                                county,
                                state,
                                county_ranked,
                                v002_rawvalue,
                                v063_rawvalue,
                                v011_rawvalue,
                                v009_rawvalue,
                                v143_rawvalue) 


```

The selected variables for analysis include poor or fair health, median household income, adult obesity, adult smoking, and insufficient sleep. In Analysis 1, median household income serves as the predictor for the outcome variable poor or fair health. Analysis 2 examines adult smoking as a predictor of adult obesity, while Analysis 3 focuses on insufficient sleep as the primary variable of interest.

# Variable Cleaning and Renaming

The selected variables were renamed to align with the data dictionary:

```{r variable renaming and cleaning}


chr_2023 <- chr_2023 %>% rename(Poor_or_fair_health = v002_rawvalue,
                    Median_household_income = v063_rawvalue,
                    Adult_obesity = v011_rawvalue,
                    adult_smoking = v009_rawvalue,
                    insufficent_sleep = v143_rawvalue) %>% mutate(Poor_or_fair_health = Poor_or_fair_health * 100,
                                                                  Median_household_income = Median_household_income / 1000,
                                                                  Adult_obesity = Adult_obesity * 100,
                                                                  adult_smoking = adult_smoking * 100,
                                                                  insufficent_sleep = insufficent_sleep * 100)



```

All variables, except for Median Household Income, were multiplied by 100 to convert their values from proportions to percentages. Median Household Income was divided by 1,000 to express it in thousands of dollars for better readability.

# Creating the Analysis 2 Predictor

The percentage of adult smokers in a county will be categorized into three groups: "Low", "Medium", and "High" based on quantile cutoffs.

* "Low": Counties in the bottom 40% (≤ 18.9%)
* "Medium": Counties in the middle 20% (between 18.9% and 20.9%)
* "High": Counties in the top 40% (≥ 20.9%)

```{r creater analysis 2 factor}

# Compute quantile cutoffs
chr_2023 %>%
  summarise(q40 = quantile(adult_smoking, c(0.4), na.rm = TRUE),  # Bottom 40% cutoff
            q60 = quantile(adult_smoking, c(0.6), na.rm = TRUE))  # Top 40% cutoff

# Categorize adult smoking into "Low", "Medium", and "High" groups
chr_2023 <- chr_2023 %>%
  mutate(adult_smoking_grp = case_when(
    adult_smoking <= 18.9 ~ "Low",
    adult_smoking > 18.9 & adult_smoking < 20.9 ~ "Medium",
    adult_smoking >= 20.9 ~ "High")) %>%
  mutate(adult_smoking_grp = factor(adult_smoking_grp, levels = c("Low", "Medium", "High")))

# Count occurrences in each category
chr_2023 %>% count(adult_smoking_grp)


```

The majority of counties fall into the 'Low' (1,233 counties) and 'High' (1,277 counties) smoking groups, while fewer counties (571) are classified as 'Medium.' Only one county has missing data.


# Adding 2018 Data for the Analysis 3 Outcome

Analysis will be done with the variable insufficient sleep to determine if the sleep quality has worsened for these counties between 2018 and 2023. The 2018 data is read in with read_csv() and is joined to the original data set using the function left join().

```{r joining 2018 data}


chr_2018_raw <- read_csv(suppressWarnings(here("data/raw/chr_2018.csv")), guess_max = 4000, show_col_types = FALSE)


chr_2018_raw <- chr_2018_raw %>% mutate(fipscode = as.character(fipscode))

chr_2018 <- chr_2018_raw %>% select(fipscode, v143_rawvalue)

chr_2023 <- left_join(chr_2023, chr_2018, by = "fipscode")

chr_2023 <- chr_2023 %>% rename(insufficent_sleep_2018 = v143_rawvalue) %>% 
                         mutate(insufficent_sleep_2018 = insufficent_sleep_2018 * 100) %>% 
                         rename(insufficent_sleep_2023 = insufficent_sleep)


```


# Arranging and Saving the Analytic Tibble

```{r SavingTibbles}

chr_2023 <- chr_2023 %>% select(fipscode, state, county, Poor_or_fair_health, Median_household_income, Adult_obesity, adult_smoking_grp, adult_smoking, insufficent_sleep_2023, insufficent_sleep_2018, county_ranked)

write_csv(chr_2023, here("data/processed/chr_2023.csv"))
saveRDS(chr_2023, here("data/processed/chr_2023.rds"))

```

# Print the Tibble

The tibble is printed to confirm that:

1. It is a tibble (instead of a data frame or another object type).
2. All variables have the correct data types, ensuring compatibility with the analysis.

```{r tibble printing}

chr_2023

```

Expected data types:

* `fipscode` and `county` → Character (chr)
* `state` and `adult_smoking_grp` → Factor (fct)
* All other quantitative variables → Double (dbl)

# Numerical Summaries

```{r numerical summary}

describe(chr_2023)

```

# The Codebook

The **chr_2023** tibble contains *3082* counties and *11* variables.

|          Variable           |   Original    |        Role        |  NA | Distinct | Definition                                                                                              | Source                                         | Year(s) |
|:------:|:------:|:------:|-------:|-------:|--------------------|--------|--------|
|        **fipscode**         |      --       |         ID         |   0 |      611 | county's FIPS code                                                                                      | --                                             | --      |
|          **state**          |      --       |         ID         |   0 |        6 | state postal abbreviation                                                                               | --                                             | --      |
|         **county**          |      --       |         ID         |   0 |      529 | county name                                                                                             | --                                             | --      |
|   **Poor_or_fair_health**   | v002_rawvalue |  Outcome Variable  |   0 |      169 | Percentage of adults reporting fair or poor health                                                      | The Behavioral Risk Factor Surveillance System | 2020    |
| **Median_household_income** | v063_rawvalue | Predictor Variable |   0 |      608 | The median income of a household in thousands of dollars                                                | US Census Bureau                               | 2021    |
|      **Adult_obesity**      | v011_rawvalue |  Outcome Variable  |   0 |      160 | Percentage of the adult population that reports a body mass index (BM) greater than or equal to 30kg/m2 | The Behavioral Risk Factor Surveillance System | 2020    |
|    **adult_smoking_grp**    | adult_smoking | Predictor Variable | 119 |        2 | A binary variable that divides the percentage of adult smokers into high and low groups                 | The Behavioral Risk Factor Surveillance System | 2020    |
|      **adult_smoking**      | v009_rawvalue | Predictor variable |   0 |      175 | Percentage of adult who are current smokers                                                             | The Behavioral Risk Factor Surveillance System | 2020    |
| **insufficient_sleep_2023** | v143_rawvalue |  Outcome variable  |   0 |      138 | The percentage of adults who report fewer than 7 hours of sleep on average in 2023                      | The Behavioral Risk Factor Surveillance System | 2020    |
| **insufficient_sleep_2018** | v143_rawvalue |  Outcome variable  |  60 |      551 | The percentage of adults who report fewer than 7 hours of sleep on average in 2018                      | The Behavioral Risk Factor Surveillance System | 2016    |
|      **county_ranked**      |      --       |       Check        |   0 |        1 | Ensuring all values are 1                                                                               | --                                             | --      |

**Missingness Check**


```{r missing check}
gg_miss_var(chr_2023)
```


```{r}

# Calculate the percentage of missing values for each variable
chr_2023 %>%
  summarise(missing_percent = mean(is.na(insufficent_sleep_2018)) * 100)


```

All quantitative variables have no missing data, except for `insufficient_sleep_2018`, which has approximately 10% missing values. However, this is well below the 20% threshold, making it unlikely to impact the analysis significantly.


**Distinct Values Check**


```{r}
sapply(chr_2023, function(x) n_distinct(x))
```

All of the quantitative variables have more than 15 distinct values, with the smallest number of smallest distinct values being 138 for insufficient sleep 2023.

# Research Questions

## Analysis 1 Research Question

What is the relationship between median household income and health outcomes across all U.S. counties? Counties with lower household incomes may have reduced access to healthcare and fewer economic opportunities, potentially leading to worse health outcomes.

## Analysis 2 Research Question

Is there an association between adult smoking rates and obesity prevalence? Since nicotine is a stimulant that suppresses appetite, we hypothesize that counties with higher smoking rates will have lower obesity rates.

## Analysis 3 Research Question

How has the average sleep quality in U.S. counties changed from 2018 to 2023?

# Analysis 1

## Variables

Two quantitative variables will be used to conduct the analysis and determine the association between them. The variables being used are `Median_household_income` as the predictor variable and `Poor_or_fair_health` as the outcome variable.` Median_household_income` represents the median reported income of households (in thousands of dollars) for a given county. `Poor_or_fair_health` is the percentage of adults self-reporting either fair or poor health in response to the question: "Would you say that in general your health is Excellent, Very Good, Good, Fair, or Poor?" The data set includes all counties in the United States.

## Summaries

Numerical Summaries of Household income and poor of fair health outcomes:

```{r}

s1 <- mosaic::favstats(~ Median_household_income, data = chr_2023)
s2 <- mosaic::favstats(~ Poor_or_fair_health, data = chr_2023)
s3 <- bind_rows(list(Median_Household_Income = s1, Poor_or_fair_health = s2), .id = "id") 
s3 <- s3 %>% rename(Variable = id)
s3 %>% gt() %>% fmt_number(decimals = 2)


```


The summary statistics for the data set provide insight into the distribution of median household income and self-reported poor or fair health across 3,081 U.S. counties. The median household income ranges from \$25.65K to \$153.72K, with a median of \$56.63K and a mean of \$58.91K, suggesting a right-skewed distribution, where some counties have significantly higher incomes. The standard deviation of \$15.29K indicates moderate variation in income levels across counties.


```{r}

# Compute Pearson correlation
income_cor <- glue("Pearson correlation = {round(cor(chr_2023$Median_household_income, 
                                                      chr_2023$Poor_or_fair_health, use = 'complete.obs'), 3)}")

# Plot
ggplot(chr_2023, aes(x = Median_household_income, y = Poor_or_fair_health)) + 
  geom_point(size = 2) + 
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = TRUE) +
  geom_smooth(method = "loess", formula = y ~ x, col = "steelblue", se = FALSE) + 
  theme_bw() + 
  geom_text(aes(x = 175, y = 35, label = income_cor), hjust = 1, size = 4) +  
  labs(title = "Association between Household Income and Poor or Fair Health Outcomes",
       subtitle = "Fitted with Linear Model and Loess Regression Curves",
       x = "Median Household Income (Thousands of Dollars)",
       y = "Percentage of Poor or Fair Health Outcomes",
       caption = "Source: 2023 County Health Rankings")


```

The "loess" smooth curve deviates significantly from the linear regression model, suggesting that a linear relationship may not fully capture the trend in the data. The non-linearity is particularly evident at lower income levels, where the decline in poor or fair health percentages is steep, before flattening out at higher income levels. This indicates that a simple linear model may not be the best fit for this data.

To address this, a transformation will be applied to the predictor variable (`Median_Household_Income`), and potentially the outcome variable (`Poor_or_fair_health`), to improve linearity. A Box-Cox transformation plot will be used to determine an appropriate transformation approach.

Additionally, the strong negative Pearson correlation coefficient (-0.713) suggests a moderate-to-strong inverse relationship between median household income and poor health outcomes, meaning counties with higher median incomes tend to report fewer cases of poor or fair health.


```{r}

boxCox(chr_2023$Poor_or_fair_health ~ chr_2023$Median_household_income)

powerTransform(chr_2023$Poor_or_fair_health ~ chr_2023$Median_household_income)

```


Based on the Box-Cox plot and the power transformation equation, a lambda value of -0.33 was obtained, suggesting that the optimal transformation for the predictor variable is *1/sqrt(y)*. However, to maintain interpret ability and consistency, this analysis will be constrained to commonly used transformations, such as inverse, logarithmic, or square root transformations. Given that logarithmic transformation is the closest alternative to the suggested power transformation, a log transformation will be applied to the Poor_or_fair_health outcome variable.

```{r}

# Compute Pearson correlation
income_cor <- glue("Pearson correlation = {round(cor(chr_2023$Median_household_income, 
                                                      log(chr_2023$Poor_or_fair_health), use = 'complete.obs'), 3)}")

ggplot(chr_2023, aes(x = Median_household_income, y = log(Poor_or_fair_health))) + 
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = FALSE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + 
  geom_text(aes(x = 155, y = 5, label = income_cor), hjust = 1, size = 4) +  
  theme_bw() + 
  labs(title = "Association between Household income vs. Log of Poor or fair health outcomes",
       x = "Median Household Income (Thousands of Dollars)",
       y = "Log Percentage of Poor or Fair Health Outcomes",
       subtitle = "Source: 2023 County Health Rankings")
```


```{r}

p1 <- ggplot(chr_2023, aes(x = Median_household_income, y = Poor_or_fair_health)) + geom_point(size = 2) + 
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = FALSE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + theme_bw() + 
  labs(title = "Household income vs. Poor or fair health outcomes",
       subtitle = "Fitted with Linear Model and Loess Regression Curves",
       x = "Median Household Income (Thousands of Dollars)",
       y = "% Poor Health Outcomes")

p2 <- ggplot(chr_2023, aes(x = log(Median_household_income), y = log(Poor_or_fair_health))) + geom_point(size = 2) + 
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = FALSE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + theme_bw() + 
  labs(title = "Log Household income vs. Log Poor or fair health outcomess",
        subtitle = "Fitted with Linear Model and Loess Regression Curves",
       x = "Log Median Household Income (Thousands of Dollars)",
       y = "Log % Poor Health Outcomes")


p1 / p2
```

The log transformation of the `Poor_or_fair_health` outcome variable has improved the linearity of the relationship between median household income and self-reported poor or fair health outcomes. Compared to the original plot, the loess curve (blue) and the linear regression line (red) now align more closely, indicating that the transformed model better captures the underlying trend.

The negative Pearson correlation coefficient (-0.713) remains the same, reaffirming a moderate-to-strong inverse relationship between income and poor health outcomes. However, with the log transformation, the spread of values appears more consistent across different income levels, potentially reducing heteroscedasticity in the data. This transformation ensures that the linear regression model assumptions are better met, allowing for a more accurate estimation of the relationship between household income and health outcomes. Further diagnostic checks will confirm whether additional refinements are necessary.

## Model

```{r}

m1 <- lm(log(Poor_or_fair_health) ~ log(Median_household_income), data = chr_2023)

tidy(lm(log(Poor_or_fair_health) ~ log(Median_household_income), data = chr_2023),conf.int = TRUE, conf.level = 0.90) %>%
  gt() %>% fmt_number(decimals = 3)


glance(lm(log(Poor_or_fair_health) ~ log(Median_household_income), data = chr_2023)) %>% select(r.squared, sigma, nobs) %>% gt() %>% fmt_number(decimals = c(3))

```


The regression model estimates the relationship between median household income and poor or fair health outcomes using a log-log transformation. The resulting equation, indicates that a 1% increase in median household income is associated with an 0.87% decrease in the percentage of adults reporting poor or fair health. This suggests a strong negative relationship between income and poor health outcomes, meaning counties with higher median household incomes tend to have fewer residents reporting poor or fair health.

The model was fitted to 3,081 observations and explains 61.3% of the variance in poor health outcomes (R² = 0.613), suggesting a moderately strong fit. The residual standard error (σ = 0.168) reflects the typical deviation of observed values from predictions in the log-transformed scale. Additionally, the p-values for both the intercept and slope are highly significant, confirming a statistically meaningful relationship between household income and health outcomes. This analysis provides strong evidence that higher income levels are linked to better self-reported health outcomes, reinforcing the idea that economic factors play a critical role in public health disparities.

```{r}

par(mfrow=c(1,2)); plot(m1, which = 1:2); par(mfrow = c(1,1))

```
The Residuals vs. Fitted plot assesses the assumption of homoscedasticity (constant variance of residuals) and linear relationship. The red loess curve shows a slight curvature, indicating that the model may not fully capture a potential non-linear pattern in the data. Additionally, the spread of residuals appears to narrow at lower fitted values and widen at higher fitted values, suggesting some heteroscedasticity (non-constant variance). While not extreme, this pattern indicates that the model might benefit from further refinements, such as checking interactions or considering additional transformations.

The Q-Q Plot (right) evaluates the normality of residuals, a key assumption for reliable hypothesis testing and confidence intervals. The residuals mostly follow the theoretical normal distribution, aligning well along the 45-degree reference line. However, there are some deviations at the tails, particularly at the upper end, where a few extreme residuals (outliers) deviate from normality. This suggests that while the residuals are approximately normal, there may be some influence from high-leverage points or outliers that could impact model accuracy.

Overall, while the model performs reasonably well, the presence of slight heteroscedasticity and minor non-normality suggests that additional diagnostic tests (such as other transformations or robust regression techniques) may be useful to further improve model fit and reliability.



```{r}

chr_2023_aug <- augment(m1, newdata = chr_2023)

chr_2023_aug %>% select(state, county, Poor_or_fair_health, Median_household_income, .fitted, .resid) %>%
  mutate(std_resid_manual = .resid / sd(.resid, na.rm = TRUE)) -> cc_high

cc_high %>% arrange(desc(std_resid_manual)) %>% head(n = 2)



```


The counties with the largest absolute residual values were East Carroll Parish County in and Holmes County both in the state of Texas. Their residuals values were 3.179016 and 2.927130 respectively.


## Conclusions

This analysis aimed to determine whether counties with higher median household incomes are associated with a lower percentage of adults reporting poor or fair health outcomes. By fitting a log-log linear model, we observed a strong negative relationship between these two variables, where a 1% increase in median household income is associated with an estimated 0.87% decrease in the percentage of adults reporting poor or fair health. The 90% confidence interval for the income coefficient is [-0.891, -0.850], confirming that the effect is statistically significant and suggesting a consistent inverse association between income and health outcomes.The model achieved an R-squared value of 0.613, meaning it explains 61.3% of the variability in poor or fair health outcomes across U.S. counties. While this indicates a moderately strong fit, there remains some unexplained variation, which may be influenced by additional socioeconomic or healthcare access factors not accounted for in this model.

A key limitation arises from the residuals vs. fitted plot, which indicates some heteroscedasticity, meaning the variance of residuals is not constant across income levels. This is particularly noticeable at the lower and upper ends of the income distribution, suggesting that the predictive power of the model may be weaker for very low- or high-income counties. Additionally, the Q-Q plot shows minor deviations from normality, with a few high-leverage outliers. These extreme residuals suggest that certain counties have significantly different actual health outcomes than what the model predicts, potentially due to unmeasured regional or policy differences.

To improve the model's predictive power and address heteroscedasticity, future analysis could explore alternative transformations, such as:

* A generalized linear model (GLM) with a different link function, which may better capture the relationship.
* Additional socioeconomic predictors, such as education levels, healthcare access, or employment rates, to enhance explanatory power.
* A weighted regression approach, where counties with extreme values contribute proportionally less to the model.
* Robust regression techniques, which reduce the influence of outliers and improve model stability.

Despite these limitations, the analysis provides strong evidence that higher household incomes are associated with better self-reported health outcomes, reinforcing the broader understanding of the relationship between economic conditions and public health.

# Analysis 2

## Variables

`adult_smoking` is an age-adjusted quantitative variable that measures the percentage of adults who are current smokers. The data was collected through surveys, where respondents were asked, "Do you now smoke cigarettes every day, some days, or not at all?" Individuals who responded "every day" or "some days" were classified as smokers. The analysis follows an independent sample design, where each county is categorized into one of two smoking groups, and the groups are then compared against one another. The Adult Smoking Group variable is a categorical variable that classifies counties into Low, medium, and High smoking prevalence groups:

* Low Smoking Group: Counties in the bottom 40% of adult smoking prevalence.
* High Smoking Group: Counties in the top 40% of adult smoking prevalence.
* Middle 20% Excluded: Counties with adult smoking rates in the middle 20% 

`Adult_Obesity` is an age-adjusted quantitative variable that measures the percentage of the adult population that reported a body mass index (BMI) greater than or equal to 30 kg/m\^2. The data was collected through self-reported surveys, where adults reported their height and weight, from which BMI was calculated.


## Summaries


```{r}

smoke <- chr_2023 %>% filter(complete.cases(Adult_obesity, adult_smoking, adult_smoking_grp)) %>% select(fipscode:county, Adult_obesity, adult_smoking, adult_smoking_grp)

mosaic::favstats(Adult_obesity ~ adult_smoking_grp, data = smoke) %>% gt() %>% fmt_number(decimals = 2)

```


The table provides descriptive statistics for adult smoking prevalence across three county-level groups: Low, Medium, and High Smoking Counties. These groups were determined by ranking counties based on their smoking rates, with the bottom 40% classified as Low Smoking, the top 40% as High Smoking, and the middle 20% as Medium Smoking.

Counties in the Low Smoking group (n = 1,233) have smoking rates ranging from 17.6% to 49.0%, with a median of 33.6% and an average smoking rate of 33.02%. The standard deviation of 4.42 suggests moderate variability in smoking rates within this group. The Medium Smoking group (n = 571) has smoking rates between 25.6% and 46.7%, with a median of 36.5% and an average of 36.49%. The standard deviation of 3.04 indicates that smoking rates in this group are more tightly clustered compared to the Low and High groups. The High Smoking group (n = 1,277) consists of counties where adult smoking rates range from 28.6% to 53.2%, with a median of 39.1% and an average smoking rate of 39.31%. This group has the lowest standard deviation (3.15), suggesting that smoking rates are relatively consistent within counties classified as high-smoking.

Overall, the distribution of smoking rates is well separated across the three groups, with distinct median and mean values. This categorization ensures a meaningful comparison between counties with significantly different smoking prevalence rates while excluding the middle 20% to strengthen group differences.

```{r}

smoke %>% ggplot(aes(x = adult_smoking_grp, y = Adult_obesity)) + geom_violin(fill = "ivory") + 
  geom_boxplot(width = 0.3, fill = "steelblue", outlier.size = 2, notch = TRUE) +
  stat_summary(fun = "mean", geom = "point", shape = 23, size = 2, fill = "black") +
  labs(title = "Adult Obesity Rates for Adult Smoker Groups",
       subtitle = "Data from 611 Counties",
       x = "Smoking Group",
       y = "Adult Obesity Percentage",
       caption = "Source: 2023 County Health Rankings") + coord_flip() + theme_bw()

```

The violin plot illustrates the distribution of adult obesity rates across three smoking groups (Low, Medium, and High Smoking Counties), providing insight into the relationship between smoking prevalence and obesity. The plot reveals a general trend where counties with higher smoking rates tend to have higher median obesity rates compared to those with lower smoking rates. This supports the hypothesis that lower smoking prevalence may be associated with higher obesity rates, potentially due to nicotine’s appetite-suppressing effects.

The High Smoking group has the highest median obesity rate, approximately 38-40%, with a wide spread of values, indicating substantial variation in obesity rates among high-smoking counties. The Medium Smoking group shows a slightly lower median obesity rate with moderate variability, while the Low Smoking group has the lowest median obesity rate, around 32-34%, and a narrower distribution, suggesting more consistency in obesity rates among counties with lower smoking prevalence.

Outliers are present in all groups, with some counties showing extremely low (<20%) or high (>50%) obesity rates, indicating that additional factors such as diet, socioeconomic status, and healthcare access may contribute to obesity rates beyond smoking prevalence alone.

Overall, the data suggest a positive association between smoking prevalence and obesity rates, where counties with higher smoking rates tend to have higher obesity rates. However, given the overlap between groups, further statistical testing is necessary to determine whether these differences are statistically significant and to control for potential confounding variables that may influence obesity levels across counties.



```{r}

p1 <- smoke %>% filter(adult_smoking_grp == "Low") %>% ggplot(aes(sample = Adult_obesity)) +
  geom_qq() +
  geom_qq_line(col = "red") + 
  theme(aspect.ratio = 1) +
  labs(title = "Low Smoking Group",
       x = "Expectation for Standard Normal ",
       y = "Adult Obesity Percentage")

p2 <- smoke %>% filter(adult_smoking_grp == "Medium") %>% ggplot(aes(sample = Adult_obesity)) +
  geom_qq() +
  geom_qq_line(col = "red") + 
  theme(aspect.ratio = 1) +
  labs(title = "Medium Smoking Group",
       x = "Expectation for Standard Normal ",
       y = "Adult Obesity Percentage")


p3 <- smoke %>% filter(adult_smoking_grp == "High") %>% ggplot(aes(sample = Adult_obesity)) +
  geom_qq() +
  geom_qq_line(col = "red") + 
  theme(aspect.ratio = 1) +
  labs(title = "High Smoking Group",
       x = "Expectation for Standard Normal ",
       y = "Adult Obesity Percentage")

p1 + p2 + p3


```


The Q-Q plots for the Low, Medium, and High Smoking groups assess whether the distribution of adult obesity percentages follows a normal distribution within each smoking category. In an ideal normal distribution, the data points would align closely along the 45-degree reference line (red line).

For the Low Smoking group, the data mostly follows the normal distribution in the middle range but deviates at the lower and upper tails, indicating the presence of mild skewness or outliers. The Medium Smoking group exhibits a similar pattern, with some deviation in the tails, particularly in the upper end where counties with very high obesity rates are present. The High Smoking group shows the most noticeable deviation from normality, especially at the upper tail, where a cluster of counties has exceptionally high obesity rates.

These deviations in the upper tails across all groups suggest that a small subset of counties has significantly higher obesity rates than what would be expected under normality. This could indicate the influence of additional factors such as socioeconomic status, physical activity levels, or healthcare access that contribute to obesity rates beyond smoking prevalence. Overall, while the core distributions of obesity rates within each smoking group are roughly normal, the presence of right-skewed data and outliers in the higher obesity ranges suggests that statistical tests assuming normality should be interpreted with caution. If necessary, data transformations or non-parametric tests may be considered for further analysis.

## Model

Due to the data does not following a normal distribution due to having some significant skew in both groups a non-parametric test will be used. Variation will also be checked for both groups.

```{r}

smoke %>% group_by(adult_smoking_grp) %>% summarise(n = n(), Variance = var(Adult_obesity)) 

```

The variance of adult obesity rates was calculated for each smoking group. The Low Smoking group had the highest variance (19.50), indicating greater variability in obesity rates among counties with lower smoking prevalence. In contrast, the Medium (9.27) and High (9.93) Smoking groups had much lower variances, suggesting more consistent obesity rates in counties with moderate-to-high smoking prevalence. The notable difference in variance between the Low Smoking group and the other two groups further justifies the use of Welch’s T-test, which does not assume equal variances.

Since the data does not follow a normal distribution, as indicated by the Q-Q plots, and the variance differs between groups, a Welch's ANOVA will be used instead of the standard . Welch's ANOVA is more appropriate in cases where heteroscedasticity (unequal variances) exists across groups, ensuring more reliable statistical inference. These findings suggest that obesity rates are more variable in counties with lower smoking rates, whereas counties with higher smoking prevalence tend to have more uniform obesity levels. Further analysis will assess whether the observed differences in means are statistically significant.



```{r}
 
anova_results <- oneway.test(Adult_obesity ~ adult_smoking_grp, 
                             data = smoke, 
                             var.equal = FALSE)  # Welch’s ANOVA


anova_results


```
The results indicate a highly significant effect (F = 850.15, p < 2.2e-16), suggesting that at least one group’s mean obesity rate differs significantly from the others. Since the p-value is far below 0.05, we reject the null hypothesis that all groups have the same mean obesity rate. However, Welch’s ANOVA does not specify which groups differ from each other, so we need to perform post hoc comparisons to determine where the significant differences lie.


To further investigate the differences in means and obtain confidence intervals, we can use the Games-Howell post hoc test, which is suitable for datasets with unequal variances.

```{r}

games_howell_results <- games_howell_test(Adult_obesity ~ adult_smoking_grp, data = smoke)

games_howell_results %>% gt() %>% fmt_number(decimals = 2)


```


The results indicate that all three pairwise comparisons (Low vs. Medium, Low vs. High, and Medium vs. High Smoking Groups) are statistically significant (p < 0.001 across all comparisons). The Medium Smoking group has an average adult obesity rate that is 3.46 percentage points higher than the Low Smoking group. The 95% confidence interval [3.04, 3.88] confirms this difference is statistically significant. The High Smoking group has an average obesity rate that is 6.29 percentage points higher than the Low Smoking group, indicating a stronger difference than the previous comparison. The 95% confidence interval [5.93, 6.65] further supports this finding. The High Smoking group has an average obesity rate that is 2.82 percentage points higher than the Medium Smoking group. The 95% confidence interval [2.46, 3.19] suggests a smaller but still significant difference.

These findings suggest that smoking prevalence is positively associated with obesity rates, though further research is needed to explore underlying causal mechanisms such as socioeconomic factors, diet, or physical activity levels.

## Conclusions

This analysis aimed to determine whether counties in the U.S. with higher smoking prevalence are associated with lower or higher obesity rates among adults. Contrary to the initial hypothesis that higher smoking rates would correlate with lower obesity rates, the results indicate the opposite trend—counties with a higher percentage of adult smokers tend to have higher obesity rates.

Using Welch’s ANOVA, a statistically significant difference (p < 2.2e-16) in adult obesity rates across smoking groups was observed. Games-Howell post hoc comparisons further confirmed that all group differences were significant:

* Medium Smoking counties had an obesity rate 3.46 percentage points higher than Low Smoking counties.
* High Smoking counties had an obesity rate 6.29 percentage points higher than Low Smoking counties.
* High Smoking counties also had an obesity rate 2.82 percentage points higher than Medium Smoking counties.

These findings suggest a positive association between smoking prevalence and obesity rates, challenging the assumption that higher smoking rates might contribute to lower obesity levels due to nicotine’s appetite-suppressing effects.

While this analysis provides evidence of a statistical relationship, several limitations must be considered. Although data was collected from all U.S. counties, state-level differences in policies, healthcare access, and socioeconomic conditions could still introduce variability in the results. The relationship between smoking and obesity may differ based on urban vs. rural settings, state regulations on tobacco use, or regional dietary patterns, which were not explicitly controlled for in this analysis. Additionally, the data was collected via self-reported surveys, which introduces potential biases such as voluntary response bias, where individuals choosing to participate may not be fully representative of the broader population. Underreporting or overreporting behaviors in self-reported health metrics could also affect the accuracy of the results.

Future research that could improve this analysis would be to incorporate additional variables, such as income levels, physical activity rates, and healthcare access, to better understand the mechanisms driving the observed association between smoking prevalence and obesity rates. Future studies could also explore whether the relationship differs between urban and rural counties or if state-level policy interventions (such as smoking bans or taxation) influence the trends observed in this study.

# Analysis 3

## Variables

This analysis examines changes in insufficient sleep prevalence between 2018 and 2023 using a paired sample design. The dataset includes the percentage of adults reporting insufficient sleep in both years, with counties serving as the pairing variable to ensure that the comparison reflects within-county changes over time. Insufficient sleep is an age-adjusted quantitative variable representing the percentage of adults who report averaging fewer than seven hours of sleep per night. The data was collected through self-reported surveys, where participants responded to the question: “On average, how many hours of sleep do you get in a 24-hour period?”. Adults reporting fewer than seven hours were classified as experiencing insufficient sleep.

This paired sample design allows for a precise comparison by controlling for county-level differences that could influence sleep patterns, such as demographics, local policies, or environmental factors. The primary statistical approach will be a paired t-test, which assesses whether there is a significant difference in insufficient sleep prevalence between 2018 and 2023.

## Summaries

```{r}

slp <- chr_2023 %>% filter(complete.cases(insufficent_sleep_2023, insufficent_sleep_2018)) %>% select(fipscode:county, insufficent_sleep_2023, insufficent_sleep_2018)

slp <- slp %>% mutate(sleep_diff = insufficent_sleep_2023 - insufficent_sleep_2018)

sleep1 <- mosaic::favstats(~ insufficent_sleep_2023, data = slp)
sleep2 <- mosaic::favstats(~ insufficent_sleep_2018, data = slp)
sleep4 <- mosaic::favstats(~ sleep_diff, data = slp)
sleep3 <- bind_rows(list(insufficent_sleep_2023 = sleep1, insufficent_sleep_2018 = sleep2,sleep_diff = sleep4 ))
sleep3$Variable <- c("insufficent sleep 2023", "insufficent sleep 2018", "Sleep Difference" )
sleep3 <- sleep3 %>% select(Variable, min:missing)
sleep3 %>% gt() %>% fmt_number(decimals = 2)

```


The summary statistics provide insight into changes in insufficient sleep prevalence between 2018 and 2023 across 2,768 U.S. counties. The mean percentage of adults reporting insufficient sleep in 2023 was 34.55%, slightly higher than the 33.15% recorded in 2018. The median values show a similar pattern, increasing from 33.6% in 2018 to 34.6% in 2023, suggesting a slight overall increase in the prevalence of insufficient sleep. The standard deviation is slightly lower in 2023 (3.50) compared to 2018 (4.06), indicating that the distribution of sleep deprivation rates has become slightly more consistent over time.

The computed sleep difference variable (2023 minus 2018) has a mean increase of 1.41 percentage points, with a range from -8.6 to 9.76. The negative values indicate that some counties experienced a reduction in insufficient sleep rates, while others saw an increase, with most changes clustering near zero. The standard deviation of 2.34 suggests that the magnitude of change varies across counties, though most changes remain within a few percentage points. These results suggest that, on average, insufficient sleep has become slightly more common between 2018 and 2023, but with considerable variability across counties. A paired t-test will be conducted to determine whether this observed increase is statistically significant.

```{r}

p1 <- slp %>% ggplot(aes(sample = sleep_diff)) +
  geom_qq() +
  geom_qq_line(col = "steelblue") +
  theme(aspect.ratio = 1) +
  labs(title = "Normal Q-Q Plot",
       x = "Expectation under Standard Normal",
       y = "Sleep 2023 - Sleep 2018") + theme_bw()


p2 <- slp %>% ggplot(aes(x = sleep_diff)) +
  geom_histogram(aes(y = after_stat(density)),
                 bins = 15, fill = "steelblue", col = "black") +
  stat_function(fun = dnorm, args = list(mean = mean(slp$sleep_diff, na.rm = TRUE),
                                         sd = sd(slp$sleep_diff, na.rm = TRUE)),
                col = "red", lwd = 1.5) +
  labs(title = "Histogram of Sleep Difference",
       subtitle = "Imposed with Normal Density Function",
       x = "Change in Sleep Percentage",
       y = "Density") + theme_bw() + scale_y_continuous(expand = c(0,0))


p3 <- slp %>% ggplot(aes(x = sleep_diff, y = "")) +
  geom_violin(fill = "ivory") +
  geom_boxplot(fill = "steelblue", width = 0.5, outlier.size = 2, notch = TRUE) +
  stat_summary(fun = "mean", geom = "point", shape = 23, size = 2, fill = "black") +
  labs(title = "Boxplot of Sleep Difference",
       x = "Change in Sleep Percentage",
       y = "") + theme_bw()


p1 + (p2 / p3 + plot_layout(heights = c(4,1))) +
  plot_annotation(title = "Percent Change in Insufficent Sleep Between 2023 and 2018",
                  subtitle = "n = 611 Counties",
                  caption = "Source: 2023 and 2018 County Health Rankings")


```

The three visualizations show the distribution of changes in insufficient sleep prevalence between 2018 and 2023 across 551 counties. The Normal Q-Q Plot suggests that the differences in insufficient sleep percentages are approximately normally distributed, as most points closely follow the diagonal reference line, with only minor deviations at the extremes. This indicates that a paired t-test is appropriate for analyzing the differences between the two years.

The histogram of sleep differences, overlaid with a normal density curve, further supports this observation. The distribution appears unimodal and symmetric, centered around zero, indicating that while some counties experienced increases in insufficient sleep prevalence, others saw decreases, with most changes clustering around a small positive shift. This aligns with previous summary statistics, which showed a mean increase of about 1.41 percentage points.

The boxplot of sleep differences reveals the spread and presence of outliers. Most counties have sleep differences ranging from approximately -5 to +5 percentage points, with a few extreme values exceeding ±8 percentage points. The presence of mild outliers suggests that while most counties experienced small changes, a few had more dramatic shifts in sleep deprivation rates.Overall, these visualizations confirm that the distribution of sleep differences is approximately normal, justifying the use of parametric statistical tests such as a paired t-test to determine whether the observed mean difference is statistically significant.



```{r}

sleep_cor <- str_glue("Pearson correlation = ", round_half_up(cor(slp$insufficent_sleep_2018, slp$insufficent_sleep_2023), 3))

ggplot(slp, aes(x = insufficent_sleep_2018, y = insufficent_sleep_2023)) + geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = TRUE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + theme_bw() +
  geom_text(label = sleep_cor, x = 27, y = 45 ) +
  labs(title = "Association between Insufficent Sleep in 2018 and 2023",
       subtitle = "Fitted with a Linear Model and Loess Regression Curves",
       x = "Percentage of Insufficent Sleep in 2018",
       caption = "Source: 2023 County Health Rankings",
       y = "Percentage of Insufficent Sleep in 2023")

```

The scatterplot shows the association between insufficient sleep prevalence in 2018 and 2023 across U.S. counties, with both a linear regression model (red line) and a loess regression curve (blue line) fitted to the data. The Pearson correlation coefficient of 0.818 indicates a strong positive linear relationship, suggesting that counties with higher insufficient sleep percentages in 2018 tended to also have higher insufficient sleep percentages in 2023. The linear regression model (red line) closely follows the trend of the data, showing a consistent, positive association between the two years. The loess curve (blue line) aligns well with the linear model, suggesting that the relationship remains approximately linear across the range of insufficient sleep percentages, with no major deviations or non-linear trends.

Despite the strong correlation, there is some spread in the data, indicating county-level variability in sleep trends. While most counties followed a similar trajectory, some experienced larger increases or decreases in insufficient sleep prevalence than expected. This variation could be influenced by differences in public health policies, socioeconomic conditions, or lifestyle factors across regions.

The strong correlation suggests that insufficient sleep trends are persistent over time, with counties that had high sleep deprivation rates in 2018 continuing to report high rates in 2023. However, individual county-level differences highlight the need for further exploration into factors driving changes in sleep behavior over time.

## Model

```{r}

t.test(slp$sleep_diff, data = smoke, conf.int = TRUE, conf.level = 0.90) %>% tidy() %>% gt() %>% fmt_number(decimals = 2)

```


A one-sample t-test was conducted to determine whether the mean change in insufficient sleep prevalence between 2018 and 2023 was statistically significant. The test produced a highly significant result (p < 0.001), indicating that the observed mean difference is unlikely to be due to random chance. The estimated mean difference in insufficient sleep percentages is 1.41 percentage points, meaning that, on average, counties experienced a 1.41% increase in the proportion of adults reporting insufficient sleep from 2018 to 2023. The 90% confidence interval [1.33, 1.48] suggests that the true mean difference in the population likely falls within this range, further reinforcing the significance of the result.

The t-statistic of 31.58 with 2,767 degrees of freedom is very large, providing strong evidence against the null hypothesis that there is no change in sleep deprivation rates over time. Since the test was two-sided, it accounts for the possibility of both increases and decreases, though in this case, the positive estimate confirms an upward trend in insufficient sleep prevalence.

These findings provide statistically significant evidence that insufficient sleep rates have increased in U.S. counties between 2018 and 2023. While the observed increase of 1.41 percentage points may seem small, it represents a consistent trend across counties, potentially reflecting broader societal changes such as increased stress levels, lifestyle shifts, or declining sleep hygiene practices.


## Conclusions


This analysis aimed to determine whether there was a significant change in the percentage of adults reporting insufficient sleep across the same U.S. counties between 2018 and 2023. The results indicate a statistically significant increase in insufficient sleep prevalence over this period. The median percentage of adults reporting insufficient sleep in 2023 was 34.6% (IQR: 3.6), compared to 33.6% in 2018 (IQR: 4.86), suggesting a slight but consistent upward trend. A paired t-test confirmed a mean increase of 1.41 percentage points, with a 90% confidence interval of [1.33, 1.48], providing strong evidence that insufficient sleep rates have risen in U.S. counties over time.

One limitation of this analysis is missing data that is likely "Missing Not at Random" (MNAR). Notably, all 58 counties in California lacked insufficient sleep data for 2018, meaning California was entirely excluded from the analysis. Since California represents a significant portion of the U.S. population, its absence may introduce regional bias into the findings.

A potential next step for future research would be to explore underlying factors contributing to changes in sleep deprivation, such as economic stress, work-life balance, increased screen time, or public health interventions. Additionally, controlling for confounding variables—such as income levels, employment status, and regional differences in healthcare access—could provide deeper insight into the drivers of increasing sleep deprivation. Further analysis could also compare urban vs. rural counties to assess whether geographic location influences sleep trends over time.

# Session Information

```{r}

# quarto::quarto_render("Analysis.qmd", output_format = "pdf")

```


```{r}
session_info()
```



