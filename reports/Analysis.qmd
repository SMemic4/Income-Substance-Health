---
title: "The Impact of Income and Substance Use on Health Outcomes in US Counties"
subtitle: "Using Data from CHR 2023"
date: last-modified
format:
  html:
    css: styles.css
    toc: true
    number-sections: true
    date-format: iso
    embed-resources: true
    code-overflow: wrap
    theme: default
---


```{r}

knitr::opts_chunk$set(warning = FALSE)

```


```{r}
#| message: false

library(Hmisc)
library(janitor)
library(naniar)
library(sessioninfo)
library(car)
library(mosaic)
suppressPackageStartupMessages(library(here))
library(gt)
library(glue)
library(patchwork)
library(broom)
library(tidyverse)



theme_set(theme_bw())
knitr::opts_chunk$set(comment = NA)
```

# Data Ingest

```{r Data Task 1 Ingest the raw data}


data_url <- "https://www.countyhealthrankings.org/sites/default/files/media/document/analytic_data2023_0.csv"

chr_2023_raw <- read_csv(data_url, skip = 1, guess_max = 4000,show_col_types = FALSE)


chr_2023_raw <- chr_2023_raw %>% filter(county_ranked == 1)

dim(chr_2023_raw)


```

# State Selection

The goal of the analysis will include all of the counties in the Unitied States of America. 

```{r State Selection}


chr_2023 <- chr_2023_raw %>% mutate(state = factor(state))

chr_2023 %>% count(state)

nrow(chr_2023)


```

There are 3082 total counties in this data set.


# Variable Selection

```{r variable selection}

chr_2023 <- chr_2023 %>% select(fipscode, 
                                county,
                                state,
                                county_ranked,
                                v002_rawvalue,
                                v063_rawvalue,
                                v011_rawvalue,
                                v009_rawvalue,
                                v143_rawvalue) 


```

The selected variables for analysis include poor or fair health, median household income, adult obesity, adult smoking, and insufficient sleep. In Analysis 1, median household income serves as the predictor for the outcome variable poor or fair health. Analysis 2 examines adult smoking as a predictor of adult obesity, while Analysis 3 focuses on insufficient sleep as the primary variable of interest.

# Variable Cleaning and Renaming

The selected variables were renamed to align with the data dictionary:

```{r variable renaming and cleaning}


chr_2023 <- chr_2023 %>% rename(Poor_or_fair_health = v002_rawvalue,
                    Median_household_income = v063_rawvalue,
                    Adult_obesity = v011_rawvalue,
                    adult_smoking = v009_rawvalue,
                    insufficent_sleep = v143_rawvalue) %>% mutate(Poor_or_fair_health = Poor_or_fair_health * 100,
                                                                  Median_household_income = Median_household_income / 1000,
                                                                  Adult_obesity = Adult_obesity * 100,
                                                                  adult_smoking = adult_smoking * 100,
                                                                  insufficent_sleep = insufficent_sleep * 100)



```

All variables, except for Median Household Income, were multiplied by 100 to convert their values from proportions to percentages. Median Household Income was divided by 1,000 to express it in thousands of dollars for better readability.

# Creating the Analysis 2 Predictor

The percentage of adult smokers in a county will be categorized into three groups: "Low", "Medium", and "High" based on quantile cutoffs.
* "Low": Counties in the bottom 40% (≤ 18.9%)
* "Medium": Counties in the middle 20% (between 18.9% and 20.9%)
* "High": Counties in the top 40% (≥ 20.9%)

```{r creater analysis 2 factor}

# Compute quantile cutoffs
chr_2023 %>%
  summarise(q40 = quantile(adult_smoking, c(0.4), na.rm = TRUE),  # Bottom 40% cutoff
            q60 = quantile(adult_smoking, c(0.6), na.rm = TRUE))  # Top 40% cutoff

# Categorize adult smoking into "Low", "Medium", and "High" groups
chr_2023 <- chr_2023 %>%
  mutate(adult_smoking_grp = case_when(
    adult_smoking <= 18.9 ~ "Low",
    adult_smoking > 18.9 & adult_smoking < 20.9 ~ "Medium",
    adult_smoking >= 20.9 ~ "High")) %>%
  mutate(adult_smoking_grp = factor(adult_smoking_grp, levels = c("Low", "Medium", "High")))

# Count occurrences in each category
chr_2023 %>% count(adult_smoking_grp)


```

The majority of counties fall into the 'Low' (1,233 counties) and 'High' (1,277 counties) smoking groups, while fewer counties (571) are classified as 'Medium.' Only one county has missing data.


# Adding 2018 Data for the Analysis 3 Outcome

Analysis will be done with the variable insufficient sleep to determine if the sleep quality has worsened for these counties between 2018 and 2023. The 2018 data is read in with read_csv() and is joined to the original data set using the function left join().

```{r joining 2018 data}


chr_2018_raw <- read_csv(suppressWarnings(here("data/raw/chr_2018.csv")), guess_max = 4000, show_col_types = FALSE)


chr_2018_raw <- chr_2018_raw %>% mutate(fipscode = as.character(fipscode))

chr_2018 <- chr_2018_raw %>% select(fipscode, v143_rawvalue)

chr_2023 <- left_join(chr_2023, chr_2018, by = "fipscode")

chr_2023 <- chr_2023 %>% rename(insufficent_sleep_2018 = v143_rawvalue) %>% 
                         mutate(insufficent_sleep_2018 = insufficent_sleep_2018 * 100) %>% 
                         rename(insufficent_sleep_2023 = insufficent_sleep)


```


# Arranging and Saving the Analytic Tibble

```{r SavingTibbles}

chr_2023 <- chr_2023 %>% select(fipscode, state, county, Poor_or_fair_health, Median_household_income, Adult_obesity, adult_smoking_grp, adult_smoking, insufficent_sleep_2023, insufficent_sleep_2018, county_ranked)

write_csv(chr_2023, here("data/processed/chr_2023.csv"))
saveRDS(chr_2023, here("data/processed/chr_2023.rds"))

```

# Print the Tibble

The tibble is printed to confirm that:

1. It is a tibble (instead of a data frame or another object type).
2. All variables have the correct data types, ensuring compatibility with the analysis.

```{r tibble printing}

chr_2023

```

Expected data types:

* `fipscode` and `county` → Character (chr)
* `state` and `adult_smoking_grp` → Factor (fct)
* All other quantitative variables → Double (dbl)

# Numerical Summaries

```{r numerical summary}

describe(chr_2023)

```

# The Codebook

The **chr_2023** tibble contains *3082* counties and *11* variables.

|          Variable           |   Original    |        Role        |  NA | Distinct | Definition                                                                                              | Source                                         | Year(s) |
|:------:|:------:|:------:|-------:|-------:|--------------------|--------|--------|
|        **fipscode**         |      --       |         ID         |   0 |      611 | county's FIPS code                                                                                      | --                                             | --      |
|          **state**          |      --       |         ID         |   0 |        6 | state postal abbreviation                                                                               | --                                             | --      |
|         **county**          |      --       |         ID         |   0 |      529 | county name                                                                                             | --                                             | --      |
|   **Poor_or_fair_health**   | v002_rawvalue |  Outcome Variable  |   0 |      169 | Percentage of adults reporting fair or poor health                                                      | The Behavioral Risk Factor Surveillance System | 2020    |
| **Median_household_income** | v063_rawvalue | Predictor Variable |   0 |      608 | The median income of a household in thousands of dollars                                                | US Census Bureau                               | 2021    |
|      **Adult_obesity**      | v011_rawvalue |  Outcome Variable  |   0 |      160 | Percentage of the adult population that reports a body mass index (BM) greater than or equal to 30kg/m2 | The Behavioral Risk Factor Surveillance System | 2020    |
|    **adult_smoking_grp**    | adult_smoking | Predictor Variable | 119 |        2 | A binary variable that divides the percentage of adult smokers into high and low groups                 | The Behavioral Risk Factor Surveillance System | 2020    |
|      **adult_smoking**      | v009_rawvalue | Predictor variable |   0 |      175 | Percentage of adult who are current smokers                                                             | The Behavioral Risk Factor Surveillance System | 2020    |
| **insufficient_sleep_2023** | v143_rawvalue |  Outcome variable  |   0 |      138 | The percentage of adults who report fewer than 7 hours of sleep on average in 2023                      | The Behavioral Risk Factor Surveillance System | 2020    |
| **insufficient_sleep_2018** | v143_rawvalue |  Outcome variable  |  60 |      551 | The percentage of adults who report fewer than 7 hours of sleep on average in 2018                      | The Behavioral Risk Factor Surveillance System | 2016    |
|      **county_ranked**      |      --       |       Check        |   0 |        1 | Ensuring all values are 1                                                                               | --                                             | --      |

**Missingness Check**


```{r missing check}
gg_miss_var(chr_2023)
```


```{r}

# Calculate the percentage of missing values for each variable
chr_2023 %>%
  summarise(missing_percent = mean(is.na(insufficent_sleep_2018)) * 100)


```

All quantitative variables have no missing data, except for `insufficient_sleep_2018`, which has approximately 10% missing values. However, this is well below the 20% threshold, making it unlikely to impact the analysis significantly.


**Distinct Values Check**


```{r}
sapply(chr_2023, function(x) n_distinct(x))
```

All of the quantitative variables have more than 15 distinct values, with the smallest number of smallest distinct values being 138 for insufficient sleep 2023.

# Research Questions

## Analysis 1 Research Question

What is the relationship between median household income and health outcomes across all U.S. counties? Counties with lower household incomes may have reduced access to healthcare and fewer economic opportunities, potentially leading to worse health outcomes.

## Analysis 2 Research Question

Is there an association between adult smoking rates and obesity prevalence? Since nicotine is a stimulant that suppresses appetite, we hypothesize that counties with higher smoking rates will have lower obesity rates.

## Analysis 3 Research Question

How has the average sleep quality in U.S. counties changed from 2018 to 2023?

# Analysis 1

## Variables

Two quantitative variables will be used to conduct the analysis and determine the association between them. The variables being used are `Median_household_income` as the predictor variable and `Poor_or_fair_health` as the outcome variable.` Median_household_income` represents the median reported income of households (in thousands of dollars) for a given county. `Poor_or_fair_health` is the percentage of adults self-reporting either fair or poor health in response to the question: "Would you say that in general your health is Excellent, Very Good, Good, Fair, or Poor?" The data set includes all counties in the United States.

## Summaries

Numerical Summaries of Household income and poor of fair health outcomes:

```{r}

s1 <- mosaic::favstats(~ Median_household_income, data = chr_2023)
s2 <- mosaic::favstats(~ Poor_or_fair_health, data = chr_2023)
s3 <- bind_rows(list(Median_Household_Income = s1, Poor_or_fair_health = s2), .id = "id") 
s3 <- s3 %>% rename(Variable = id)
s3 %>% gt() %>% fmt_number(decimals = 2)


```


The summary statistics for the data set provide insight into the distribution of median household income and self-reported poor or fair health across 3,081 U.S. counties. The median household income ranges from \$25.65K to \$153.72K, with a median of \$56.63K and a mean of \$58.91K, suggesting a right-skewed distribution, where some counties have significantly higher incomes. The standard deviation of \$15.29K indicates moderate variation in income levels across counties.


```{r}

# Compute Pearson correlation
income_cor <- glue("Pearson correlation = {round(cor(chr_2023$Median_household_income, 
                                                      chr_2023$Poor_or_fair_health, use = 'complete.obs'), 3)}")

# Plot
ggplot(chr_2023, aes(x = Median_household_income, y = Poor_or_fair_health)) + 
  geom_point(size = 2) + 
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = TRUE) +
  geom_smooth(method = "loess", formula = y ~ x, col = "steelblue", se = FALSE) + 
  theme_bw() + 
  geom_text(aes(x = 175, y = 35, label = income_cor), hjust = 1, size = 4) +  
  labs(title = "Association between Household Income and Poor or Fair Health Outcomes",
       subtitle = "Fitted with Linear Model and Loess Regression Curves",
       x = "Median Household Income (Thousands of Dollars)",
       y = "Percentage of Poor or Fair Health Outcomes",
       caption = "Source: 2023 County Health Rankings")


```

The "loess" smooth curve deviates significantly from the linear regression model, suggesting that a linear relationship may not fully capture the trend in the data. The non-linearity is particularly evident at lower income levels, where the decline in poor or fair health percentages is steep, before flattening out at higher income levels. This indicates that a simple linear model may not be the best fit for this data.

To address this, a transformation will be applied to the predictor variable (`Median_Household_Income`), and potentially the outcome variable (`Poor_or_fair_health`), to improve linearity. A Box-Cox transformation plot will be used to determine an appropriate transformation approach.

Additionally, the strong negative Pearson correlation coefficient (-0.713) suggests a moderate-to-strong inverse relationship between median household income and poor health outcomes, meaning counties with higher median incomes tend to report fewer cases of poor or fair health.


```{r}

boxCox(chr_2023$Poor_or_fair_health ~ chr_2023$Median_household_income)

powerTransform(chr_2023$Poor_or_fair_health ~ chr_2023$Median_household_income)

```


Based on the Box-Cox plot and the power transformation equation, a lambda value of -0.33 was obtained, suggesting that the optimal transformation for the predictor variable is *1/sqrt(y)*. However, to maintain interpret ability and consistency, this analysis will be constrained to commonly used transformations, such as inverse, logarithmic, or square root transformations. Given that logarithmic transformation is the closest alternative to the suggested power transformation, a log transformation will be applied to the Poor_or_fair_health outcome variable.

```{r}

# Compute Pearson correlation
income_cor <- glue("Pearson correlation = {round(cor(chr_2023$Median_household_income, 
                                                      log(chr_2023$Poor_or_fair_health), use = 'complete.obs'), 3)}")

ggplot(chr_2023, aes(x = Median_household_income, y = log(Poor_or_fair_health))) + 
  geom_point(size = 2) +
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = FALSE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + 
  geom_text(aes(x = 155, y = 5, label = income_cor), hjust = 1, size = 4) +  
  theme_bw() + 
  labs(title = "Association between Household income vs. Log of Poor or fair health outcomes",
       x = "Median Household Income (Thousands of Dollars)",
       y = "Log Percentage of Poor or Fair Health Outcomes",
       subtitle = "Source: 2023 County Health Rankings")
```


```{r}

p1 <- ggplot(chr_2023, aes(x = Median_household_income, y = Poor_or_fair_health)) + geom_point(size = 2) + 
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = FALSE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + theme_bw() + 
  labs(title = "Household income vs. Poor or fair health outcomes",
       subtitle = "Fitted with Linear Model and Loess Regression Curves",
       x = "Median Household Income (Thousands of Dollars)",
       y = "% Poor Health Outcomes")

p2 <- ggplot(chr_2023, aes(x = log(Median_household_income), y = log(Poor_or_fair_health))) + geom_point(size = 2) + 
  geom_smooth(method = "lm", formula = y ~ x, col = "red", se = FALSE) +
  geom_smooth(method = "loess", formula = y~x, col = "steelblue", se = FALSE) + theme_bw() + 
  labs(title = "Log Household income vs. Log Poor or fair health outcomess",
        subtitle = "Fitted with Linear Model and Loess Regression Curves",
       x = "Log Median Household Income (Thousands of Dollars)",
       y = "Log % Poor Health Outcomes")


p1 / p2
```

The log transformation of the `Poor_or_fair_health` outcome variable has improved the linearity of the relationship between median household income and self-reported poor or fair health outcomes. Compared to the original plot, the loess curve (blue) and the linear regression line (red) now align more closely, indicating that the transformed model better captures the underlying trend.

The negative Pearson correlation coefficient (-0.713) remains the same, reaffirming a moderate-to-strong inverse relationship between income and poor health outcomes. However, with the log transformation, the spread of values appears more consistent across different income levels, potentially reducing heteroscedasticity in the data. This transformation ensures that the linear regression model assumptions are better met, allowing for a more accurate estimation of the relationship between household income and health outcomes. Further diagnostic checks will confirm whether additional refinements are necessary.

## Model

```{r}

m1 <- lm(log(Poor_or_fair_health) ~ log(Median_household_income), data = chr_2023)

tidy(lm(log(Poor_or_fair_health) ~ log(Median_household_income), data = chr_2023),conf.int = TRUE, conf.level = 0.90) %>%
  gt() %>% fmt_number(decimals = 3)


glance(lm(log(Poor_or_fair_health) ~ log(Median_household_income), data = chr_2023)) %>% select(r.squared, sigma, nobs) %>% gt() %>% fmt_number(decimals = c(3))

```


The regression model estimates the relationship between median household income and poor or fair health outcomes using a log-log transformation. The resulting equation, indicates that a 1% increase in median household income is associated with an 0.87% decrease in the percentage of adults reporting poor or fair health. This suggests a strong negative relationship between income and poor health outcomes, meaning counties with higher median household incomes tend to have fewer residents reporting poor or fair health.

The model was fitted to 3,081 observations and explains 61.3% of the variance in poor health outcomes (R² = 0.613), suggesting a moderately strong fit. The residual standard error (σ = 0.168) reflects the typical deviation of observed values from predictions in the log-transformed scale. Additionally, the p-values for both the intercept and slope are highly significant, confirming a statistically meaningful relationship between household income and health outcomes. This analysis provides strong evidence that higher income levels are linked to better self-reported health outcomes, reinforcing the idea that economic factors play a critical role in public health disparities.

```{r}

par(mfrow=c(1,2)); plot(m1, which = 1:2); par(mfrow = c(1,1))

```
The Residuals vs. Fitted plot assesses the assumption of homoscedasticity (constant variance of residuals) and linear relationship. The red loess curve shows a slight curvature, indicating that the model may not fully capture a potential non-linear pattern in the data. Additionally, the spread of residuals appears to narrow at lower fitted values and widen at higher fitted values, suggesting some heteroscedasticity (non-constant variance). While not extreme, this pattern indicates that the model might benefit from further refinements, such as checking interactions or considering additional transformations.

The Q-Q Plot (right) evaluates the normality of residuals, a key assumption for reliable hypothesis testing and confidence intervals. The residuals mostly follow the theoretical normal distribution, aligning well along the 45-degree reference line. However, there are some deviations at the tails, particularly at the upper end, where a few extreme residuals (outliers) deviate from normality. This suggests that while the residuals are approximately normal, there may be some influence from high-leverage points or outliers that could impact model accuracy.

Overall, while the model performs reasonably well, the presence of slight heteroscedasticity and minor non-normality suggests that additional diagnostic tests (such as other transformations or robust regression techniques) may be useful to further improve model fit and reliability.

```{r}

chr_2023_aug <- augment(m1, data = chr_2023)
cc_high <- chr_2023_aug %>% select(state,county, Poor_or_fair_health, Median_household_income, .fitted, .resid, .std.resid) %>% mutate(abs_resid = abs(.resid))
cc_high %>% arrange(desc(abs_resid)) %>% head(n = 2)
```

The counties with the largest absolute residual values were Dallam County in and Presidio County both in the state of Texas. Their residuals values were 0.564 and 0.492 respectively.

## Conclusions

This analysis aimed to determine whether counties with higher median household incomes are associated with a lower percentage of adults reporting poor or fair health outcomes. By fitting a log-log linear model, we observed a strong negative relationship between these two variables, where a 1% increase in median household income is associated with an estimated 0.87% decrease in the percentage of adults reporting poor or fair health. The 90% confidence interval for the income coefficient is [-0.891, -0.850], confirming that the effect is statistically significant and suggesting a consistent inverse association between income and health outcomes.The model achieved an R-squared value of 0.613, meaning it explains 61.3% of the variability in poor or fair health outcomes across U.S. counties. While this indicates a moderately strong fit, there remains some unexplained variation, which may be influenced by additional socioeconomic or healthcare access factors not accounted for in this model.

A key limitation arises from the residuals vs. fitted plot, which indicates some heteroscedasticity, meaning the variance of residuals is not constant across income levels. This is particularly noticeable at the lower and upper ends of the income distribution, suggesting that the predictive power of the model may be weaker for very low- or high-income counties. Additionally, the Q-Q plot shows minor deviations from normality, with a few high-leverage outliers. These extreme residuals suggest that certain counties have significantly different actual health outcomes than what the model predicts, potentially due to unmeasured regional or policy differences.

To improve the model's predictive power and address heteroscedasticity, future analysis could explore alternative transformations, such as:
* A generalized linear model (GLM) with a different link function, which may better capture the relationship.
* Additional socioeconomic predictors, such as education levels, healthcare access, or employment rates, to enhance explanatory power.
* A weighted regression approach, where counties with extreme values contribute proportionally less to the model.
* Robust regression techniques, which reduce the influence of outliers and improve model stability.

Despite these limitations, the analysis provides strong evidence that higher household incomes are associated with better self-reported health outcomes, reinforcing the broader understanding of the relationship between economic conditions and public health.






